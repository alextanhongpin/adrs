# Generate and/or propagate correlation id

## Who

Backend. REST-based API or GraphQL.

## What

Correlation id is a unique identifier for a request. The correlation id is usually extracted from the HTTP headers (e.g. `X-Request-ID`). If not found, then it is usually generated by the application.

The correlation id will then be passed to other services handling the request.

## Why

- we want to uniquely identify a request by their correlation id
- we want to add the correlation id to applications logs, to ease tracing
- we want to return the correlation id to the client when an error occur


## When

- client: when making a request to another service
- server: when receiving requests from a client

## How


- when making a request to another service, set the correlation id in the header
- when a request is received, extract the correlation id or generate a new one if none
- when logging, include the correlation id together with the timestamp


The example below demonstrates how to set and get the correlation id from the header:
```go
package main

import (
	"fmt"
	"net/http"

	"github.com/segmentio/ksuid"
)

func main() {
	headers := make(http.Header)
	headers.Set("X-Request-ID", ksuid.New().String())
	fmt.Println(headers.Get("X-Request-ID"))
}
```

The example below demonstrates passing the context containing the correlation id to services that handles the request, as well as logging the request id on error/info:

```go
package main

import (
	"context"
	"errors"
	"fmt"
	"log"
	"net/http"

	"github.com/segmentio/ksuid"
)

var RequestID contextkey[string] = "request_id"

type contextkey[T any] string

func (key contextkey[T]) WithValue(ctx context.Context, val T) context.Context {
	return context.WithValue(ctx, key, val)
}

func (key contextkey[T]) Value(ctx context.Context) (t T, found bool) {
	t, found = ctx.Value(key).(T)

	return
}

func (key contextkey[T]) MustValue(ctx context.Context) T {
	requestID, found := key.Value(ctx)
	if !found {
		panic("context: requestID not found")
	}

	return requestID
}

func main() {
	headers := make(http.Header)
	headers.Set("X-Request-ID", ksuid.New().String())

	requestID := headers.Get("X-Request-ID")
	fmt.Println("requestID:", requestID)

	ctx := context.Background()
	ctx = RequestID.WithValue(ctx, requestID)

	if err := createUser(ctx, ""); err != nil {
		err = fmt.Errorf("%w: failed to create user: request_id=%s", err, RequestID.MustValue(ctx))
		log.Println(err)
	}

	if err := createUser(ctx, "john"); err != nil {
		err = fmt.Errorf("%w: failed to create user: request_id=%s", err, RequestID.MustValue(ctx))
		log.Println(err)
	}
}

func createUser(ctx context.Context, name string) error {
	if name == "" {
		return errors.New("name is required")
	}

	log.Printf("creating user: name=%s, request_id=%s\n", name, RequestID.MustValue(ctx))

	return nil
}
```
